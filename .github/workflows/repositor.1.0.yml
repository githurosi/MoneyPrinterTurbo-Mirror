name: Download Latest OpenCore Assets
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œå¯æŒ‰éœ€æ·»åŠ è‡ªåŠ¨è§¦å‘ï¼ˆå¦‚å®šæ—¶ï¼‰
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©å‡Œæ™¨è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write  # éœ€å†™å…¥æƒé™ä»¥ä¿å­˜èµ„äº§

jobs:
  download-latest-assets:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è·å–æœ€æ–° Release ä¿¡æ¯
        id: get-latest-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # éœ€åœ¨ä»“åº“ Secrets ä¸­é…ç½®
        run: |
          # è°ƒç”¨ GitHub API è·å–æœ€æ–° Release
          response=$(curl -s https://api.github.com/repos/acidanthera/OpenCorePkg/releases/latest)
          export TAG_NAME=$(echo "$response" | jq -r '.tag_name')
          # å‡è®¾ä¼˜å…ˆä¸‹è½½ OpenCore-<ç‰ˆæœ¬>-RELEASE.zip èµ„äº§ï¼Œè‹¥ä¸å­˜åœ¨å†æ‰¾å…¶ä»–
          export ASSETS_URL=$(echo "$response" | jq -r '.assets[] | select(.name | startswith("OpenCore-" + env.TAG_NAME + "-RELEASE.zip")) | .browser_download_url')
          if [ -z "$ASSETS_URL" ]; then
            export ASSETS_URL=$(echo "$response" | jq -r '.assets[0].browser_download_url')
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ASSETS_URL=$ASSETS_URL" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æœ€æ–°èµ„äº§
        if: steps.get-latest-release.outputs.ASSETS_URL != ''
        run: |
          echo "å¼€å§‹ä¸‹è½½æœ€æ–°èµ„äº§: ${{ steps.get-latest-release.outputs.TAG_NAME }}"
          wget -q --show-progress ${{ steps.get-latest-release.outputs.ASSETS_URL }} -O OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-RELEASE.zip

      - name: æäº¤æ›´æ–°
        if: steps.get-latest-release.outputs.ASSETS_URL != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“¦ æ›´æ–° OpenCorePkg åˆ° ${{ steps.get-latest-release.outputs.TAG_NAME }}"
          files: |
            OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-RELEASE.zip
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
