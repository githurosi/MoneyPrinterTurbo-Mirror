name: Download OpenCore Assets
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œå¯æŒ‰éœ€æ·»åŠ è‡ªåŠ¨è§¦å‘ï¼ˆå¦‚å®šæ—¶ï¼‰
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©å‡Œæ™¨è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write  # éœ€å†™å…¥æƒé™ä»¥ä¿å­˜èµ„äº§

jobs:
  download-latest-assets:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: è·å–æœ€æ–° Release ä¿¡æ¯
        id: get-latest-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # éœ€åœ¨ä»“åº“ Secrets ä¸­é…ç½®
        run: |
          # è°ƒç”¨ GitHub API è·å–æœ€æ–° Release
          response=$(curl -s https://api.github.com/repos/acidanthera/OpenCorePkg/releases/latest)
          export TAG_NAME=$(echo "$response" | jq -r '.tag_name')
          # æŸ¥æ‰¾ RELEASE ç‰ˆæœ¬èµ„äº§é“¾æ¥
          export RELEASE_ASSETS_URL=$(echo "$response" | jq -r '.assets[] | select(.name | startswith("OpenCore-" + env.TAG_NAME + "-RELEASE.zip")) | .browser_download_url')
          # æŸ¥æ‰¾ DEBUG ç‰ˆæœ¬èµ„äº§é“¾æ¥
          export DEBUG_ASSETS_URL=$(echo "$response" | jq -r '.assets[] | select(.name | startswith("OpenCore-" + env.TAG_NAME + "-DEBUG.zip")) | .browser_download_url')
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "RELEASE_ASSETS_URL=$RELEASE_ASSETS_URL" >> $GITHUB_OUTPUT
          echo "DEBUG_ASSETS_URL=$DEBUG_ASSETS_URL" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥å¹¶ä¸‹è½½ RELEASE ç‰ˆæœ¬èµ„äº§
        run: |
          if [ -f "OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-RELEASE.zip" ]; then
            echo "RELEASE ç‰ˆæœ¬èµ„äº§å·²å­˜åœ¨ï¼Œæ— éœ€ä¸‹è½½"
          else
            if [ -n "${{ steps.get-latest-release.outputs.RELEASE_ASSETS_URL }}" ]; then
              echo "å¼€å§‹ä¸‹è½½ RELEASE ç‰ˆæœ¬èµ„äº§: ${{ steps.get-latest-release.outputs.TAG_NAME }}"
              wget -q --show-progress ${{ steps.get-latest-release.outputs.RELEASE_ASSETS_URL }} -O OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-RELEASE.zip
            else
              echo "æœªæ‰¾åˆ° RELEASE ç‰ˆæœ¬èµ„äº§é“¾æ¥ï¼Œæ— æ³•ä¸‹è½½"
            fi
          fi

      - name: æ£€æŸ¥å¹¶ä¸‹è½½ DEBUG ç‰ˆæœ¬èµ„äº§
        run: |
          if [ -f "OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-DEBUG.zip" ]; then
            echo "DEBUG ç‰ˆæœ¬èµ„äº§å·²å­˜åœ¨ï¼Œæ— éœ€ä¸‹è½½"
          else
            if [ -n "${{ steps.get-latest-release.outputs.DEBUG_ASSETS_URL }}" ]; then
              echo "å¼€å§‹ä¸‹è½½ DEBUG ç‰ˆæœ¬èµ„äº§: ${{ steps.get-latest-release.outputs.TAG_NAME }}"
              wget -q --show-progress ${{ steps.get-latest-release.outputs.DEBUG_ASSETS_URL }} -O OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-DEBUG.zip
            else
              echo "æœªæ‰¾åˆ° DEBUG ç‰ˆæœ¬èµ„äº§é“¾æ¥ï¼Œæ— æ³•ä¸‹è½½"
            fi
          fi

      - name: æäº¤æ›´æ–°
        if: steps.get-latest-release.outputs.RELEASE_ASSETS_URL != '' || steps.get-latest-release.outputs.DEBUG_ASSETS_URL != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“¦ æ›´æ–° OpenCorePkg åˆ° ${{ steps.get-latest-release.outputs.TAG_NAME }}ï¼ŒåŒ…å« RELEASE å’Œ DEBUG ç‰ˆæœ¬èµ„äº§"
          files: |
            OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-RELEASE.zip
            OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-DEBUG.zip
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
