name: Download OpenCore Assets
on:
  workflow_dispatch:  # 手动触发，可按需添加自动触发（如定时）
  schedule:
    - cron: "0 0 * * *"  # 每天凌晨自动运行

permissions:
  contents: write  # 需写入权限以保存资产

jobs:
  download-latest-assets:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 获取最新 Release 信息
        id: get-latest-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 需在仓库 Secrets 中配置
        run: |
          # 调用 GitHub API 获取最新 Release
          response=$(curl -s https://api.github.com/repos/acidanthera/OpenCorePkg/releases/latest)
          export TAG_NAME=$(echo "$response" | jq -r '.tag_name')
          # 查找 RELEASE 版本资产链接
          export RELEASE_ASSETS_URL=$(echo "$response" | jq -r '.assets[] | select(.name | startswith("OpenCore-" + env.TAG_NAME + "-RELEASE.zip")) | .browser_download_url')
          # 查找 DEBUG 版本资产链接
          export DEBUG_ASSETS_URL=$(echo "$response" | jq -r '.assets[] | select(.name | startswith("OpenCore-" + env.TAG_NAME + "-DEBUG.zip")) | .browser_download_url')
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "RELEASE_ASSETS_URL=$RELEASE_ASSETS_URL" >> $GITHUB_OUTPUT
          echo "DEBUG_ASSETS_URL=$DEBUG_ASSETS_URL" >> $GITHUB_OUTPUT

      - name: 检查并下载 RELEASE 版本资产
        run: |
          if [ -f "OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-RELEASE.zip" ]; then
            echo "RELEASE 版本资产已存在，无需下载"
          else
            if [ -n "${{ steps.get-latest-release.outputs.RELEASE_ASSETS_URL }}" ]; then
              echo "开始下载 RELEASE 版本资产: ${{ steps.get-latest-release.outputs.TAG_NAME }}"
              wget -q --show-progress ${{ steps.get-latest-release.outputs.RELEASE_ASSETS_URL }} -O OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-RELEASE.zip
            else
              echo "未找到 RELEASE 版本资产链接，无法下载"
            fi
          fi

      - name: 检查并下载 DEBUG 版本资产
        run: |
          if [ -f "OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-DEBUG.zip" ]; then
            echo "DEBUG 版本资产已存在，无需下载"
          else
            if [ -n "${{ steps.get-latest-release.outputs.DEBUG_ASSETS_URL }}" ]; then
              echo "开始下载 DEBUG 版本资产: ${{ steps.get-latest-release.outputs.TAG_NAME }}"
              wget -q --show-progress ${{ steps.get-latest-release.outputs.DEBUG_ASSETS_URL }} -O OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-DEBUG.zip
            else
              echo "未找到 DEBUG 版本资产链接，无法下载"
            fi
          fi

      - name: 提交更新
        if: steps.get-latest-release.outputs.RELEASE_ASSETS_URL != '' || steps.get-latest-release.outputs.DEBUG_ASSETS_URL != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "📦 更新 OpenCorePkg 到 ${{ steps.get-latest-release.outputs.TAG_NAME }}，包含 RELEASE 和 DEBUG 版本资产"
          files: |
            OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-RELEASE.zip
            OpenCore-${{ steps.get-latest-release.outputs.TAG_NAME }}-DEBUG.zip
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
