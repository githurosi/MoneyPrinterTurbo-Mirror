name: Update README with OpenCore Release Notes
on:
  workflow_dispatch:  # 手动触发，可按需添加自动触发（如定时）
  schedule:
    - cron: "0 0 * * *"  # 每天凌晨自动运行

permissions:
  contents: write  # 需写入权限以更新 README 文件

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 安装 jq（确保解析 JSON）
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: 获取最新 Release 信息
        id: get-latest-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 需在仓库 Secrets 中配置
        run: |
          response=$(curl -s https://api.github.com/repos/acidanthera/OpenCorePkg/releases/latest)
          # 输出原始 API 响应内容，便于查看格式
          echo "原始 API 响应内容：$response"
          # 提取 tag_name 并处理可能的错误
          TAG_NAME=$(echo "$response" | jq -r 'if has("tag_name") then.tag_name else "" end' 2>&1)
          if [ $? -ne 0 ]; then
            echo "提取 tag_name 失败"
            TAG_NAME=""
          fi
          # 提取 body 并处理转义字符
          BODY=$(echo "$response" | jq -r 'if has("body") then.body else "" end' 2>&1)
          if [ $? -ne 0 ]; then
            echo "提取 body 失败"
            BODY=""
          else
            # 去除 \r\n 等转义字符
            BODY=$(echo "$BODY" | tr -d '\r\n')
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "BODY=$BODY" >> $GITHUB_OUTPUT

      - name: 检查并创建日志展示区域
        run: |
          if! grep -q "## OpenCore 最新版本更新日志" README.md; then
            echo "未找到日志展示区域，正在创建..."
            echo -e "\n## OpenCore 最新版本更新日志\n" >> README.md
          fi

      - name: 更新 README 文件
        run: |
          # 使用英文方括号匹配占位符，并正确处理换行
          sed -i "s/### 最新版本：\[版本号\]/### 最新版本：${TAG_NAME}/g" README.md
          sed -i "s/\[具体更新日志内容\]/$BODY/g" README.md

      - name: 提交更改
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "📄 更新 README 以展示 OpenCore 最新版本日志"
          files: README.md
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
