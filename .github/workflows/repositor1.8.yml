name: Update README with OpenCore Release Notes
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œå¯æŒ‰éœ€æ·»åŠ è‡ªåŠ¨è§¦å‘ï¼ˆå¦‚å®šæ—¶ï¼‰
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©å‡Œæ™¨è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write  # éœ€å†™å…¥æƒé™ä»¥æ›´æ–° README æ–‡ä»¶

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4

      - name: å®‰è£… jqï¼ˆç¡®ä¿è§£æ JSONï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: è·å–æœ€æ–° Release ä¿¡æ¯
        id: get-latest-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # éœ€åœ¨ä»“åº“ Secrets ä¸­é…ç½®
        run: |
          response=$(curl -s https://api.github.com/repos/acidanthera/OpenCorePkg/releases/latest)
          # è¾“å‡ºåŸå§‹ API å“åº”å†…å®¹ï¼Œä¾¿äºæŸ¥çœ‹æ ¼å¼
          echo "åŸå§‹ API å“åº”å†…å®¹ï¼š$response"
          # æå– tag_name å¹¶å¤„ç†å¯èƒ½çš„é”™è¯¯
          TAG_NAME=$(echo "$response" | jq -r 'if has("tag_name") then.tag_name else "" end' 2>&1)
          if [ $? -ne 0 ]; then
            echo "æå– tag_name å¤±è´¥"
            TAG_NAME=""
          fi
          # æå– body å¹¶å¤„ç†è½¬ä¹‰å­—ç¬¦
          BODY=$(echo "$response" | jq -r 'if has("body") then.body else "" end' 2>&1)
          if [ $? -ne 0 ]; then
            echo "æå– body å¤±è´¥"
            BODY=""
          else
            # å»é™¤ \r\n ç­‰è½¬ä¹‰å­—ç¬¦
            BODY=$(echo "$BODY" | tr -d '\r\n')
          fi
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "BODY=$BODY" >> $GITHUB_OUTPUT

      - name: æ£€æŸ¥å¹¶åˆ›å»ºæ—¥å¿—å±•ç¤ºåŒºåŸŸ
        run: |
          if! grep -q "## OpenCore æœ€æ–°ç‰ˆæœ¬æ›´æ–°æ—¥å¿—" README.md; then
            echo "æœªæ‰¾åˆ°æ—¥å¿—å±•ç¤ºåŒºåŸŸï¼Œæ­£åœ¨åˆ›å»º..."
            echo -e "\n## OpenCore æœ€æ–°ç‰ˆæœ¬æ›´æ–°æ—¥å¿—\n" >> README.md
          fi

      - name: æ›´æ–° README æ–‡ä»¶
        run: |
          # ä½¿ç”¨è‹±æ–‡æ–¹æ‹¬å·åŒ¹é…å ä½ç¬¦ï¼Œå¹¶æ­£ç¡®å¤„ç†æ¢è¡Œ
          sed -i "s/### æœ€æ–°ç‰ˆæœ¬ï¼š\[ç‰ˆæœ¬å·\]/### æœ€æ–°ç‰ˆæœ¬ï¼š${TAG_NAME}/g" README.md
          sed -i "s/\[å…·ä½“æ›´æ–°æ—¥å¿—å†…å®¹\]/$BODY/g" README.md

      - name: æäº¤æ›´æ”¹
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“„ æ›´æ–° README ä»¥å±•ç¤º OpenCore æœ€æ–°ç‰ˆæœ¬æ—¥å¿—"
          files: README.md
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
