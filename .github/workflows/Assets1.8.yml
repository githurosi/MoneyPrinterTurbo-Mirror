name: åŒæ­¥æœ€æ–°ç‰ˆæ—¥å¿—ä¸ä¸»é¡µä»‹ç»ï¼ˆæ— ç¿»è¯‘ï¼‰
on:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 1 * * *" # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œï¼ˆUTC+8ï¼‰
  workflow_dispatch:
    inputs:
      force_update:
        description: 'æ˜¯å¦å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1 # å¿«é€Ÿå…‹éš†

      - name: å®‰è£…ä¾èµ–ï¼ˆä»…ä¿ç•™è§£æå·¥å…·ï¼‰
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq wget # ç§»é™¤ translate-shell

      - name: è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯
        id: get-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="acidanthera/OpenCorePkg"
          response=$(curl -s https://api.github.com/repos/${REPO}/releases/latest)
          TAG_NAME=$(echo "$response" | jq -r '.tag_name')
          ASSETS=$(echo "$response" | jq -r '.assets[].name' | tr '\n' ',') # èµ„äº§åˆ—è¡¨è½¬ä¸ºé€—å·åˆ†éš”
          RELEASE_NOTES=$(echo "$response" | jq -r '.body') # ç›´æ¥ä½¿ç”¨è‹±æ–‡æ—¥å¿—

          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ASSETS=$ASSETS" >> $GITHUB_OUTPUT
          echo "RELEASE_NOTES=$RELEASE_NOTES" >> $GITHUB_OUTPUT

      - name: ç”Ÿæˆä¸»é¡µå†…å®¹
        run: |
          # ä¸»é¡µä»‹ç»ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
          HOMEPAGE_INTRO="# OpenCorePkg æœ€æ–°ç‰ˆæœ¬åŒæ­¥\nè¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒæ­¥ [OpenCorePkg](https://github.com/acidanthera/OpenCorePkg) æœ€æ–°ç‰ˆæœ¬èµ„äº§ä¸æ—¥å¿—çš„ä»“åº“ã€‚"

          # èµ„äº§éƒ¨åˆ†ï¼ˆè½¬ä¸ºMarkdownåˆ—è¡¨ï¼‰
          ASSET_SECTION="\n### æœ€æ–°ç‰ˆèµ„äº§\n- ${ASSETS//,/\n- }"

          # æ—¥å¿—éƒ¨åˆ†ï¼ˆç›´æ¥ä½¿ç”¨è‹±æ–‡åŸæ–‡ï¼‰
          LOG_SECTION="\n### æ›´æ–°æ—¥å¿—\n#### ${TAG_NAME}\n${RELEASE_NOTES}"

          # åˆå¹¶å†…å®¹
          ALL_CONTENT="$HOMEPAGE_INTRO$ASSET_SECTION$LOG_SECTION"

          # å†™å…¥æˆ–åˆ›å»ºREADME.md
          if [ -f README.md ]; then
            echo "$ALL_CONTENT" > README.md # è¦†ç›–å†™å…¥ï¼ˆå¦‚éœ€è¿½åŠ æ”¹ä¸º>>ï¼‰
          else
            echo "$ALL_CONTENT" >> README.md
          fi

      - name: æäº¤æ›´æ”¹
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ğŸ”„ åŒæ­¥ ${TAG_NAME} ç‰ˆæœ¬æ—¥å¿—
          files: README.md
