name: Clone Latest OpenCorePkg Assets
on:
  workflow_dispatch:  # 手动触发，可按需添加自动触发（如定时）
  schedule:
    - cron: "0 0 * * *"  # 每天凌晨自动运行

permissions:
  contents: write  # 需写入权限以保存资产

jobs:
  download-latest-assets:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4

      - name: 获取最新 Release 信息
        id: get-latest-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # 需在仓库 Secrets 中配置
        run: |
          # 调用 GitHub API 获取最新 Release
          response=$(curl -s https://api.github.com/repos/acidanthera/OpenCorePkg/releases/latest)
          export TAG_NAME=$(echo "$response" | jq -r '.tag_name')
          export ASSETS_URL=$(echo "$response" | jq -r '.assets[0].browser_download_url')
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "ASSETS_URL=$ASSETS_URL" >> $GITHUB_OUTPUT

      - name: 下载最新资产
        if: steps.get-latest-release.outputs.ASSETS_URL != ''
        run: |
          echo "开始下载最新资产: ${{ steps.get-latest-release.outputs.TAG_NAME }}"
          wget -q --show-progress ${{ steps.get-latest-release.outputs.ASSETS_URL }} -O OpenCorePkg-latest.zip

      - name: 解压资产（可选）
        if: steps.get-latest-release.outputs.ASSETS_URL != ''
        run: |
          unzip -q OpenCorePkg-latest.zip -d OpenCoreAssets
          rm OpenCorePkg-latest.zip  # 清理压缩包

      - name: 提交更新
        if: steps.get-latest-release.outputs.ASSETS_URL != ''
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "📦 更新 OpenCorePkg 到 ${{ steps.get-latest-release.outputs.TAG_NAME }}"
          files: |
            OpenCorePkg-latest.zip  # 保留压缩包或解压后的文件
            OpenCoreAssets/
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
